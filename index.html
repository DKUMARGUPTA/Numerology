<script>
  // --- Basic Config ---
  let lang = navigator.language.startsWith('hi') ? 'hi' : 'en';
  let isDarkMode = false;

  const translations = {
    placeholder: { hi: 'рдЕрдкрдирд╛ рдкреВрд░рд╛ рдирд╛рдо рд▓рд┐рдЦреЗрдВ', en: 'Your Full Name' },
    alert: { hi: 'рдХреГрдкрдпрд╛ рдирд╛рдо рдФрд░ рдЬрдиреНрдо рддрд┐рдерд┐ рднрд░реЗрдВред', en: 'Please enter your name and date of birth.' }
  };

  // --- UI Setup ---
  function toggleLanguage() {
    lang = lang === 'hi' ? 'en' : 'hi';
    document.getElementById('name').placeholder = translations.placeholder[lang];
    if (window.reportCache) generateReportFromCache();
  }

  function toggleTheme() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark-mode', isDarkMode);
    document.querySelector('.toggle-icon').textContent = isDarkMode ? 'тШАя╕П' : 'ЁЯМЩ';
  }

  // --- Core Logic ---
  function reduceToSingle(numStr) {
    let sum = numStr.split('').reduce((a, b) => a + Number(b), 0);
    while (sum > 9 && ![11, 22, 33].includes(sum)) {
      sum = sum.toString().split('').reduce((a, b) => a + Number(b), 0);
    }
    return sum;
  }

  // --- Cache last input ---
  let reportCache = null;

  function generateReport() {
    const name = document.getElementById('name').value.trim();
    const dob = document.getElementById('dob').value;
    if (!name || !dob) return alert(translations.alert[lang]);

    reportCache = { name, dob };
    generateReportFromCache();
  }

  function generateReportFromCache() {
    const { name, dob } = reportCache;
    const cleanDOB = dob.replace(/-/g, '');
    const sumAll = cleanDOB.split('').reduce((a, b) => a + Number(b), 0);
    const lifePath = reduceToSingle(sumAll.toString());
    const presentSet = new Set(cleanDOB.split('').map(Number));
    const loShu = [4,9,2,3,5,7,8,1,6];
    const missing = loShu.filter(n => !presentSet.has(n));

    // --- Interpretation ---
    const get = (key) => {
      const data = {
        lifePath: {
          hi: "рдЖрдкрдХрд╛ Life Path Number 9 рд╣реИ тАФ рдЖрдк рдПрдХ рдЖрджрд░реНрд╢рд╡рд╛рджреА, рд╕рд╣рд╛рдпрдХ рдФрд░ рд╕рдорд╛рдЬ-рд╕реЗрд╡реА рд╣реИрдВред рдЖрдк рджреВрд╕рд░реЛрдВ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рдХрд░рдирд╛ рдкрд╕рдВрдж рдХрд░рддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЕрдкрдиреА рднрд╛рд╡рдирд╛рдУрдВ рдХреЛ рдЫреБрдкрд╛рддреЗ рд╣реИрдВред рдЖрдкрдХреА рддрд╛рдХрдд: рдиреЗрддреГрддреНрд╡, рд╕рдордЭрджрд╛рд░реА, рд╕реЗрд╡рд╛ред рдЪреБрдиреМ╧ДреА: рдЕрддрд┐-рднрд╛рд╡реБрдХрддрд╛, рдЕрдкреЗрдХреНрд╖рд╛рдПрдБ, рдЖрддреНрдо-рддреНрдпрд╛рдЧред",
          en: "Your Life Path is 9 тАФ you are idealistic, helpful, and service-oriented. You prefer to do things for others but hide your own emotions. Your strengths: leadership, empathy, service. Challenges: over-emotional, expectations, self-sacrifice."
        },
        missing: {
          hi: `рдЖрдкрдХреЗ Lo Shu Grid рдореЗрдВ рдирд┐рдореНрди рдирдВрдмрд░ рдЕрдиреБрдкрд╕реНрдерд┐рдд рд╣реИрдВ: ${missing.join(', ')}ред рдЕрдиреБрд╢рд╛рд╕рди (4), рдирд┐рд░реНрдгрдп (5), рдкрд╛рд░рд┐рд╡рд╛рд░рд┐рдХ рдЬрд┐рдореНрдореЗрджрд╛рд░реА (6), рдзреИрд░реНрдп (7), рдзрди рдкреНрд░рдмрдВрдзрди (8) рдореЗрдВ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВред`,
          en: `Your Lo Shu Grid is missing: ${missing.join(', ')}. Practice: discipline (4), decision-making (5), family duty (6), patience (7), money management (8).`
        }
      };
      return data[key][lang];
    };

    // --- Build Report UI ---
    let gridHTML = '<div class="loshu-grid">';
    for (let n of loShu) {
      const cls = presentSet.has(n) ? 'present' : 'missing';
      gridHTML += `<div class="loshu-cell ${cls}">${n}</div>`;
    }
    gridHTML += '</div>';

    document.getElementById('report').innerHTML = `
      <div class="section-title">${lang === 'hi' ? 'рдЖрдкрдХреА рд░рд┐рдкреЛрд░реНрдЯ' : 'Your Report'}</div>
      <p><b>${lang === 'hi' ? 'рдирд╛рдо' : 'Name'}:</b> ${name}</p>
      <p><b>Life Path:</b> ${lifePath}</p>
      <p>${get('lifePath')}</p>
      <div class="section-title">${lang === 'hi' ? 'рд▓реЛ рд╢реБ рдЧреНрд░рд┐рдб' : 'Lo Shu Grid'}</div>
      ${gridHTML}
      <p>${get('missing')}</p>
    `;
    document.getElementById('report').style.display = 'block';
    document.getElementById('certificate').style.display = 'block';
    document.getElementById('cname').textContent = name;
    document.getElementById('clife').textContent = lifePath;
    document.getElementById('ctext').textContent = get('lifePath');
  }

  // тЬЕ GUARANTEED PDF GENERATION
  function downloadPDF() {
    if (!reportCache) {
      alert(lang === 'hi' ? 'рдкрд╣рд▓реЗ рд░рд┐рдкреЛрд░реНрдЯ рдЬрдирд░реЗрдЯ рдХрд░реЗрдВред' : 'Generate report first.');
      return;
    }

    const { name, dob } = reportCache;
    const cleanDOB = dob.replace(/-/g, '');
    const lifePath = reduceToSingle(cleanDOB.split('').reduce((a, b) => a + Number(b), 0).toString());

    const insight = {
      hi: "рдЖрдкрдХрд╛ Life Path Number 9 рд╣реИ тАФ рдЖрдк рдПрдХ рдЖрджрд░реНрд╢рд╡рд╛рджреА, рд╕рд╣рд╛рдпрдХ рдФрд░ рд╕рдорд╛рдЬ-рд╕реЗрд╡реА рд╣реИрдВред",
      en: "Your Life Path is 9 тАФ you are idealistic, helpful, and service-oriented."
    }[lang];

    // тЬи Create a clean, printable HTML string (NO CSS DEPENDENCY)
    const pdfHTML = `
      <html>
      <head>
        <meta charset="UTF-8">
        <style>
          body { font-family: Arial, sans-serif; padding: 30px; background: white; color: black; }
          .header { text-align: center; margin-bottom: 30px; }
          .header h1 { color: #6a5af9; font-size: 24px; }
          .content { background: #f9f9ff; padding: 20px; border-radius: 12px; border: 1px dashed #6a5af9; }
          .row { margin: 10px 0; }
          .label { font-weight: bold; display: inline-block; width: 150px; }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>ЁЯУЬ Cosmic Numerology Certificate</h1>
        </div>
        <div class="content">
          <div class="row"><span class="label">Name:</span> ${name}</div>
          <div class="row"><span class="label">Date of Birth:</span> ${dob}</div>
          <div class="row"><span class="label">Life Path Number:</span> ${lifePath}</div>
          <div class="row"><span class="label">Insight:</span> ${insight}</div>
        </div>
        <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #777;">
          Generated on ${new Date().toLocaleDateString()} тАв Cosmic Numerology
        </div>
      </body>
      </html>
    `;

    // Convert to Blob and download
    const blob = new Blob([pdfHTML], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = url;
    document.body.appendChild(iframe);

    // Wait for iframe to load, then print as PDF
    iframe.onload = () => {
      const opt = {
        margin: 0.5,
        filename: 'Numerology-Certificate.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, allowTaint: true },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(iframe.contentDocument.body).save().finally(() => {
        document.body.removeChild(iframe);
        URL.revokeObjectURL(url);
      });
    };
  }

  function shareWhatsApp() {
    if (!reportCache) {
      alert(lang === 'hi' ? 'рдкрд╣рд▓реЗ рд░рд┐рдкреЛрд░реНрдЯ рдЬрдирд░реЗрдЯ рдХрд░реЗрдВред' : 'Generate report first.');
      return;
    }
    const lp = reduceToSingle(reportCache.dob.replace(/-/g, '').split('').reduce((a, b) => a + Number(b), 0).toString());
    const msg = (lang === 'hi' 
      ? `рдореЗрд░рд╛ Life Path рдирдВрдмрд░ ${lp} рд╣реИ! рдЬрд╛рдирд┐рдП рдЖрдкрдХрд╛? ЁЯСЙ ` 
      : `My Life Path is ${lp}! Check yours? ЁЯСЙ `) + window.location.href;
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
  }

  // Initialize
  document.getElementById('name').placeholder = translations.placeholder[lang];
  if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) toggleTheme();
</script>
